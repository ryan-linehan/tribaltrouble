<project name="common-tools" basedir="." default="compile">
	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
		<classpath>
			<pathelement location="../common/lib/java/ant-contrib-1.0b3.jar" />
		</classpath>
	</taskdef>

	<property name="build" value="build" />
	<property name="lib" value="../common/lib/java" />
	<property name="tools" value="../tools" />
	<property name="nativelib" value="../common/lib/java" />
	<property name="commonstatic" value="../common/static" />
	<property name="java_source_version" value="1.8" />
	<import file="../classpath.xml" />


	<!-- Classpath -->
	<path id="build.classpath">
		<pathelement location="${build}" />
		<pathelement location="${commonstatic}" />
		<pathelement location="i18n" />
		<pathelement location="static" />
	</path>
	
	<target name="init">
		<tstamp />
		<mkdir dir="${build}" />
		<mkdir dir="${build}/classes" />
	</target>

	<target name="clean">
		<delete dir="${build}/classes" />
	</target>

	<target name="mrproper" depends="clean">
		<ant inheritAll="false" antfile="../build.xml" target="clean" />
		<delete dir="${build}" />
	</target>

	<target name="compile-common">
		<ant inheritAll="false" dir="../common" target="compile" />
	</target>

	<target name="compiledeps" />

	<target name="compile" depends="init,compiledeps">
		<javac debug="yes" source="${java_source_version}" target="${java_source_version}"
			srcdir="classes" destdir="${build}/classes">
			<classpath refid="platform.classpath" />
			<classpath>
				<pathelement path="${lib}/javasvn.jar" />
			</classpath>
		</javac>
	</target>

	<target name="compile-tools" depends="init,compiledeps">
		<javac debug="yes" source="${java_source_version}" target="${java_source_version}"
			srcdir="classes" destdir="${build}/classes">
			<classpath refid="platform.classpath" />
			<classpath refid="tools.classpath" />
		</javac>
	</target>

	<target name="rundeps" />

	<target name="dorundeps" depends="compile,rundeps" />

	<target name="eventloadzipped" depends="dorundeps">
		<java fork="yes" classname="${main_class}">
			<classpath refid="platform.classpath" />
			<classpath refid="build.classpath" />
			<classpath>
				<pathelement path="${build}/classes" />
			</classpath>
			<jvmarg value="-ea" />
			<jvmarg value="-Djava.library.path=${nativelib}" />
			<jvmarg value="-Dorg.lwjgl.util.Debug=true" />
			<jvmarg value="-Deventload=zipped" />
			<arg value="--eventload" />
			<arg value="zipped" />
		</java>
	</target>

	<target name="eventload" depends="dorundeps">
		<java fork="yes" classname="${main_class}">
			<classpath refid="platform.classpath" />
			<classpath refid="build.classpath" />
			<classpath>
				<pathelement path="${build}/classes" />
			</classpath>
			<jvmarg value="-ea" />
			<jvmarg value="-Djava.library.path=${nativelib}" />
			<jvmarg value="-Dorg.lwjgl.util.Debug=true" />
			<jvmarg value="-Deventload=normal" />
			<arg value="--eventload" />
			<arg value="normal" />
		</java>
	</target>

	<target name="grabframes" depends="dorundeps">
		<java fork="yes" classname="${main_class}">
			<classpath refid="platform.classpath" />
			<classpath refid="build.classpath" />
			<classpath>
				<pathelement path="${build}/classes" />
			</classpath>
			<jvmarg value="-ea" />
			<jvmarg value="-Djava.library.path=${nativelib}" />
			<jvmarg value="-Dgrabframes=true" />
			<arg value="--grabframes" />
		</java>
	</target>

	<target name="profile" depends="dorundeps">
		<java fork="yes" classname="${main_class}">
			<classpath refid="platform.classpath" />
			<classpath refid="build.classpath" />
			<classpath>
				<pathelement path="${build}/classes" />
			</classpath>
			<jvmarg value="-ea" />
			<jvmarg value="-Xbootclasspath/a:/home/elias/snot/jprofiler4/bin/agent.jar" />
			<jvmarg value="-agentlib:jprofilerti" />
			<jvmarg value="-Djava.library.path=${nativelib}" />
		</java>
	</target>

	<target name="cpuprofile" depends="dorundeps">
		<java fork="yes" classname="${main_class}">
			<classpath refid="platform.classpath" />
			<classpath refid="build.classpath" />
			<classpath>
				<pathelement path="${build}/classes" />
			</classpath>
			<jvmarg value="-ea" />
			<jvmarg value="-Djava.library.path=${nativelib}" />
			<jvmarg value="-Xrunhprof:cpu=samples" />
		</java>
	</target>

	<target name="memprofile" depends="dorundeps">
		<java fork="yes" classname="${main_class}">
			<classpath refid="platform.classpath" />
			<classpath refid="build.classpath" />
			<classpath>
				<pathelement path="${build}/classes" />
			</classpath>
			<jvmarg value="-ea" />
			<jvmarg value="-verbose:gc" />
			<jvmarg value="-Djava.library.path=${nativelib}" />
			<jvmarg value="-Xrunhprof:heap=all,depth=12,doe=y" />
		</java>
	</target>

	<target name="gcprofile" depends="dorundeps">
		<java fork="yes" classname="${main_class}">
			<classpath refid="platform.classpath" />
			<classpath refid="build.classpath" />
			<classpath>
				<pathelement path="${build}/classes" />
			</classpath>
			<jvmarg value="-ea" />
			<jvmarg value="-Djava.library.path=${nativelib}" />
			<jvmarg value="-verbose:gc" />
		</java>
	</target>

	<target name="run" depends="dorundeps">
		<!-- Use XstartOnFirstThread only if on mac-->
		<condition property="macosx.firstthread" value="true">
			<os name="Mac OS X" />
		</condition>
		<if>
			<isset property="macosx.firstthread" />
			<then>
				<java fork="yes" classname="${main_class}">
					<classpath refid="platform.classpath" />
					<classpath refid="build.classpath" />
					<classpath>
						<pathelement path="${build}/classes" />
					</classpath>
					<jvmarg value="-ea" />
					<jvmarg value="-Djava.library.path=${nativelib}" />
					<jvmarg value="-Dorg.lwjgl.util.Debug=true" />
					<jvmarg value="-Xmx80000000" />
					<jvmarg value="-Djdk.crypto.KeyAgreement.legacyKDF=true" />
					<jvmarg value="-XstartOnFirstThread" />

					<!--<jvmarg
					value="-Djavax.net.debug=ssl,handshake,trustmanager"/>-->
					<!--	<jvmarg value="-Dorg.lwjgl.opengl.Window.undecorated=true"/>-->
				</java>
			</then>
			<else>
				<java fork="yes" classname="${main_class}">
					<classpath refid="platform.classpath" />
					<classpath refid="build.classpath" />
					<classpath>
						<pathelement path="${build}/classes" />
					</classpath>
					<jvmarg value="-ea" />
					<jvmarg value="-Djava.library.path=${nativelib}" />
					<jvmarg value="-Dorg.lwjgl.util.Debug=true" />
					<jvmarg value="-Xmx80000000" />
					<jvmarg value="-Djdk.crypto.KeyAgreement.legacyKDF=true" />


					<!--<jvmarg
					value="-Djavax.net.debug=ssl,handshake,trustmanager"/>-->
					<!--	<jvmarg value="-Dorg.lwjgl.opengl.Window.undecorated=true"/>-->
				</java>
			</else>
		</if>
	</target>
</project>